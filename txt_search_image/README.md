# CLIP æ–‡æœ¬æœå›¾ç³»ç»Ÿ

åŸºäº CLIP æ¨¡å‹å’Œ Milvus å‘é‡æ•°æ®åº“çš„æ–‡æœ¬æœå›¾ç³»ç»Ÿã€‚è¾“å…¥è‡ªç„¶è¯­è¨€æè¿°ï¼Œæœç´¢å¹¶è¿”å›æœ€ç›¸å…³çš„å›¾åƒã€‚

## åŠŸèƒ½ç‰¹ç‚¹

- ğŸ–¼ï¸ **å›¾åƒå‘é‡åŒ–**: ä½¿ç”¨ CLIP æ¨¡å‹å°†å›¾åƒç¼–ç ä¸ºé«˜ç»´å‘é‡
- ğŸ“ **æ–‡æœ¬æœå›¾**: è¾“å…¥æ–‡æœ¬æè¿°ï¼Œæœç´¢è¯­ä¹‰ç›¸ä¼¼çš„å›¾åƒ
- ğŸš€ **é«˜æ•ˆæ£€ç´¢**: åŸºäº Milvus å‘é‡æ•°æ®åº“ï¼Œæ”¯æŒæµ·é‡å›¾åƒçš„å¿«é€Ÿæ£€ç´¢
- ğŸ”§ **çµæ´»é…ç½®**: æ”¯æŒå¤šç§ CLIP æ¨¡å‹ï¼Œå¯é…ç½®æœç´¢å‚æ•°
- ğŸ”„ **åŒæ¨¡å¼æ”¯æŒ**: æ”¯æŒ clip-as-service æœåŠ¡æ¨¡å¼å’Œæœ¬åœ°æ¨¡å¼

## ä¸¤ç§ç¼–ç æ¨¡å¼

| æ¨¡å¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| **service** | è¿æ¥ clip-as-service æœåŠ¡å™¨ | ç”Ÿäº§ç¯å¢ƒã€åˆ†å¸ƒå¼éƒ¨ç½²ã€å¤šå®¢æˆ·ç«¯å…±äº« |
| **local** | æœ¬åœ°ç›´æ¥åŠ è½½æ¨¡å‹ | å•æœºå¼€å‘æµ‹è¯•ã€å¿«é€ŸéªŒè¯ |

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æ–‡æœ¬æœå›¾ç³»ç»Ÿ                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚   å›¾åƒè¾“å…¥   â”‚ â”€â”€â”€â”€â”€â”€> â”‚     CLIP å›¾åƒç¼–ç å™¨      â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                        â”‚                    â”‚
â”‚                                        â–¼                    â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                            â”‚    Milvus å‘é‡æ•°æ®åº“   â”‚       â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                        â”‚                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚   æ–‡æœ¬è¾“å…¥   â”‚ â”€â”€â”€â”€â”€â”€> â”‚     CLIP æ–‡æœ¬ç¼–ç å™¨      â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                        â”‚                    â”‚
â”‚                                        â–¼                    â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                            â”‚    å‘é‡ç›¸ä¼¼åº¦æœç´¢      â”‚       â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                        â”‚                    â”‚
â”‚                                        â–¼                    â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                            â”‚     è¿”å›ç›¸ä¼¼å›¾åƒ       â”‚       â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ç¯å¢ƒå‡†å¤‡

### 1. å®‰è£…ä¾èµ–

```bash
cd txt_search_image
pip install -r requirements.txt
```

### 2. å¯åŠ¨ Milvus

ä½¿ç”¨ Docker å¿«é€Ÿå¯åŠ¨ Milvus:

```bash
# ä¸‹è½½ docker-compose é…ç½®
wget https://github.com/milvus-io/milvus/releases/download/v2.3.3/milvus-standalone-docker-compose.yml -O docker-compose.yml

# å¯åŠ¨ Milvus
docker-compose up -d

# æŸ¥çœ‹çŠ¶æ€
docker-compose ps
```

æˆ–ä½¿ç”¨ Milvus Lite (æ— éœ€ Dockerï¼Œé€‚åˆå¼€å‘æµ‹è¯•):

```python
# åœ¨ä»£ç ä¸­ä½¿ç”¨å†…å­˜æ¨¡å¼
from pymilvus import connections
connections.connect(uri="./milvus_lite.db")
```

## å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€: ä½¿ç”¨ clip-as-service æœåŠ¡æ¨¡å¼ (æ¨è)

```bash
# 1. å…ˆå¯åŠ¨ clip-as-service æœåŠ¡å™¨
python -m clip_server

# 2. ç´¢å¼•å›¾åƒ
python image_search.py --mode index --encode-mode service --clip-server grpc://localhost:51000 --image-dir /path/to/images

# 3. æ–‡æœ¬æœå›¾
python image_search.py --mode search --query "ä¸€åªå¯çˆ±çš„çŒ«å’ª" --top-k 5
```

### æ–¹å¼äºŒ: æœ¬åœ°æ¨¡å¼ (æ— éœ€å¯åŠ¨æœåŠ¡)

```bash
# ç´¢å¼•å›¾åƒ (æœ¬åœ°åŠ è½½æ¨¡å‹)
python image_search.py --mode index --encode-mode local --image-dir /path/to/images

# æ–‡æœ¬æœå›¾
python image_search.py --mode search --encode-mode local --query "ä¸€åªå¯çˆ±çš„çŒ«å’ª"
```

### Python ä»£ç è°ƒç”¨

```python
from image_search import ImageSearchEngine, print_results

# ===== æ–¹å¼ä¸€: è¿æ¥ clip-as-service æœåŠ¡ (æ¨è) =====
engine = ImageSearchEngine(
    mode='service',                        # ä½¿ç”¨æœåŠ¡æ¨¡å¼
    clip_server='grpc://localhost:51000',  # clip-as-service åœ°å€
    collection_name='my_images',
)

# ===== æ–¹å¼äºŒ: æœ¬åœ°åŠ è½½æ¨¡å‹ =====
engine = ImageSearchEngine(
    mode='local',                          # ä½¿ç”¨æœ¬åœ°æ¨¡å¼
    model_name='ViT-B-32::openai',         # æœ¬åœ°æ¨¡å‹åç§°
    collection_name='my_images',
)

# ç´¢å¼•å›¾åƒç›®å½•
engine.index_directory('/path/to/images')

# æˆ–è€…ç´¢å¼•æŒ‡å®šå›¾åƒåˆ—è¡¨ï¼Œå¸¦æè¿°
engine.index_images(
    image_paths=['cat.jpg', 'dog.jpg'],
    descriptions={
        'cat.jpg': 'ä¸€åªæ©˜è‰²çš„çŒ«',
        'dog.jpg': 'ä¸€åªé‡‘æ¯›çŠ¬'
    }
)

# æ–‡æœ¬æœå›¾
results = engine.search('ä¸€åªå¯çˆ±çš„å°çŒ«', top_k=5)
print_results(results)

# æ‰¹é‡æœç´¢
batch_results = engine.search_batch(
    ['çŒ«å’ª', 'ç‹—ç‹—', 'é£æ™¯'],
    top_k=3
)

# æŸ¥çœ‹ç»Ÿè®¡ä¿¡æ¯
stats = engine.get_stats()
print(f"æ¨¡å¼: {stats['mode']}, å·²ç´¢å¼• {stats['total_images']} å¼ å›¾åƒ")

# å…³é—­å¼•æ“
engine.close()
```

## é«˜çº§é…ç½®

### ä½¿ç”¨ä¸åŒçš„ CLIP æ¨¡å‹

```python
# æ›´é«˜ç²¾åº¦çš„æ¨¡å‹ (é€Ÿåº¦è¾ƒæ…¢)
engine = ImageSearchEngine(model_name='ViT-L-14::openai')

# LAION è®­ç»ƒçš„æ¨¡å‹
engine = ImageSearchEngine(model_name='ViT-B-32::laion2b_e16')
```

### é…ç½® Milvus è¿æ¥

```python
engine = ImageSearchEngine(
    milvus_host='192.168.1.100',  # è¿œç¨‹æœåŠ¡å™¨
    milvus_port='19530',
)
```

### è‡ªå®šä¹‰å›¾åƒæè¿°

```python
# ä» JSON æ–‡ä»¶åŠ è½½æè¿°
import json

with open('image_descriptions.json') as f:
    descriptions = json.load(f)

engine.index_directory('/path/to/images', descriptions=descriptions)
```

## å¯ç”¨çš„ CLIP æ¨¡å‹

| æ¨¡å‹åç§° | å‘é‡ç»´åº¦ | ç‰¹ç‚¹ |
|---------|---------|------|
| ViT-B-32::openai | 512 | é»˜è®¤æ¨¡å‹ï¼Œå¹³è¡¡é€Ÿåº¦å’Œç²¾åº¦ |
| ViT-B-16::openai | 512 | ç²¾åº¦æ›´é«˜ï¼Œé€Ÿåº¦ç¨æ…¢ |
| ViT-L-14::openai | 768 | é«˜ç²¾åº¦ï¼Œè¾ƒæ…¢ |
| ViT-L-14-336::openai | 768 | æœ€é«˜ç²¾åº¦ï¼Œæ”¯æŒæ›´é«˜åˆ†è¾¨ç‡ |
| ViT-B-32::laion2b_e16 | 512 | LAION æ•°æ®é›†è®­ç»ƒ |

## é¡¹ç›®ç»“æ„

```
txt_search_image/
â”œâ”€â”€ clip_encoder.py     # CLIP ç¼–ç å™¨æ¨¡å—
â”œâ”€â”€ milvus_store.py     # Milvus å­˜å‚¨æ¨¡å—
â”œâ”€â”€ image_search.py     # ä¸»æœç´¢å¼•æ“
â”œâ”€â”€ requirements.txt    # ä¾èµ–é…ç½®
â”œâ”€â”€ plan.md            # é¡¹ç›®è§„åˆ’
â””â”€â”€ README.md          # ä½¿ç”¨è¯´æ˜
```

## æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡è¿è¡Œ**: é¦–æ¬¡ä½¿ç”¨æ—¶ä¼šè‡ªåŠ¨ä¸‹è½½ CLIP æ¨¡å‹ï¼Œè¯·ç¡®ä¿ç½‘ç»œè¿æ¥æ­£å¸¸
2. **GPU åŠ é€Ÿ**: å¦‚æœ‰ NVIDIA GPUï¼Œå»ºè®®å®‰è£… CUDA ç‰ˆæœ¬çš„ PyTorch ä»¥è·å¾—æ›´å¿«çš„ç¼–ç é€Ÿåº¦
3. **å†…å­˜å ç”¨**: å¤§é‡å›¾åƒç´¢å¼•æ—¶æ³¨æ„å†…å­˜ä½¿ç”¨ï¼Œå¯é€šè¿‡è°ƒæ•´ `batch_size` å‚æ•°æ§åˆ¶
4. **Milvus æœåŠ¡**: ç¡®ä¿ Milvus æœåŠ¡æ­£å¸¸è¿è¡Œï¼Œé»˜è®¤ç«¯å£ä¸º 19530

## å¸¸è§é—®é¢˜

**Q: æœç´¢ç»“æœä¸å‡†ç¡®ï¼Ÿ**
A: å°è¯•ä½¿ç”¨æ›´å¤§çš„æ¨¡å‹ï¼ˆå¦‚ ViT-L-14ï¼‰ï¼Œæˆ–ä¼˜åŒ–æœç´¢æ–‡æœ¬çš„æè¿°ã€‚

**Q: ç¼–ç é€Ÿåº¦å¤ªæ…¢ï¼Ÿ**
A: 1) ä½¿ç”¨ GPU åŠ é€Ÿ 2) ä½¿ç”¨æ›´å°çš„æ¨¡å‹ 3) å¢å¤§ batch_size

**Q: Milvus è¿æ¥å¤±è´¥ï¼Ÿ**
A: æ£€æŸ¥ Milvus æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š`docker-compose ps`

## License

MIT License

